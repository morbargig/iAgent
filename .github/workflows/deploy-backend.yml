name: ğŸš€ Deploy Backend to Render

on:
  # Deploy backend on push to main branch (after CI passes)
  push:
    branches: [main]
    paths:
      - 'apps/backend/**'
      - 'libs/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy-backend.yml'

  # Allow manual deployment
  workflow_dispatch:

# Ensure only one deployment runs at a time
concurrency:
  group: render-backend-deployment
  cancel-in-progress: false

env:
  NODE_VERSION: "20"
  # Render deploy hook URL (should be stored as GitHub secret: RENDER_DEPLOY_HOOK)
  RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK || 'https://api.render.com/deploy/srv-d45kgn3e5dus73c7cp2g?key=YVXFP5NeUKw' }}
  # Disable Nx Cloud completely
  NX_CLOUD_DISTRIBUTED_EXECUTION: "false"
  NX_CLOUD_NO_ACCESS: "true"
  NX_SKIP_CLOUD_CACHE: "true"

jobs:
  deploy-backend:
    name: ğŸš€ Deploy Backend to Render
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit --production=false

      - name: ğŸ” Cache Nx computation cache
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-

      - name: ğŸ—ï¸ Build backend for production
        run: npx nx build @iagent/backend --configuration=production --no-cloud
        env:
          NODE_ENV: production
          NX_CLOUD_DISTRIBUTED_EXECUTION: "false"
          NX_SKIP_CLOUD_CACHE: "true"
          NX_CLOUD_NO_ACCESS: "true"

      - name: ğŸ“Š Verify build output
        run: |
          echo "ğŸ“Š Build verification:"
          echo "ğŸ“ Build directory: dist/apps/backend"
          echo "ğŸ“ Total size: $(du -sh dist/apps/backend || echo 'N/A')"

          # Check if required files exist
          if [[ -f "dist/apps/backend/main.js" ]]; then
            echo "âœ… main.js exists"
          else
            echo "âŒ main.js missing"
            exit 1
          fi

          # List main files
          echo "ğŸ“„ Main files:"
          ls -la dist/apps/backend | head -20

      - name: ğŸš€ Trigger Render Deployment
        run: |
          echo "ğŸš€ Triggering Render deployment..."
          
          RESPONSE=$(curl -X POST "${{ env.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "ğŸ“¡ Response status: $HTTP_CODE"
          echo "ğŸ“„ Response body: $BODY"
          
          if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "201" ]]; then
            echo "âœ… Render deployment triggered successfully!"
            echo "ğŸ”— Deployment ID: $(echo "$BODY" | grep -o '"id":"[^"]*"' | cut -d'"' -f4 || echo 'N/A')"
          else
            echo "âš ï¸ Render deployment hook returned status: $HTTP_CODE"
            echo "ğŸ“„ Response: $BODY"
            # Don't fail the workflow - Render might return different status codes
          fi

      - name: ğŸ“‹ Deployment summary
        run: |
          echo "ğŸ“‹ Deployment Summary:"
          echo "âœ… Backend deployment triggered successfully!"
          echo "ğŸŒ Render Service: Backend API"
          echo "ğŸ• Triggered at: $(date)"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ”— Deploy Hook: ${{ env.RENDER_DEPLOY_HOOK }}"

